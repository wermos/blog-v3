---
// src/components/FigureImage.astro
import { Image } from 'astro:assets';
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkMath from 'remark-math';
import rehypeMathjax from 'rehype-mathjax/browser';
import remarkRehype from 'remark-rehype';
import rehypeStringify from 'rehype-stringify';

interface FigureImageProps {
  caption?: string
  figureClass?: string
  captionClass?: string
  [key: string]: any
}

const { 
  caption, 
  figureClass, 
  captionClass = "text-center mt-2 text-sm text-muted-foreground",
  ...imageProps 
} = Astro.props as FigureImageProps

let processedCaption = '';
if (caption) {
  const processor = unified()
    .use(remarkParse)      // Parses markdown
    .use(remarkMath)       // Identifies math syntax
    .use(remarkRehype)     // Converts remark tree to rehype tree
    .use(rehypeMathjax)    // Processes math in rehype tree
    .use(rehypeStringify); // Converts rehype tree to HTML string
  
  const result = await processor.process(caption);
  processedCaption = String(result);
}
---

<figure class={figureClass}>
  <Image {...(imageProps as any)} />
  {caption && <figcaption class={captionClass} set:html={processedCaption} />}
</figure>
